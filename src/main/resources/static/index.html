<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼ç›²çŠ¬ä»ªè¡¨æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2.5em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 20px;
            overflow: hidden;
        }

        .card-title {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .image-container {
            width: 100%;
            height: 400px;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .image-placeholder {
            color: #999;
            text-align: center;
            font-size: 14px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .controls {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 20px;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            color: #333;
            font-size: 1.1em;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .button:hover {
            background: #764ba2;
        }

        .button.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .button.secondary:hover {
            background: #d0d0d0;
        }

        .button.danger {
            background: #f44336;
        }

        .button.danger:hover {
            background: #da190b;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.active {
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-indicator.inactive {
            background: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .ws-status {
            padding: 15px;
            background: #ffebee;
            border-left: 4px solid #f44336;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .ws-status.connected {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .log-box {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ• å¯¼ç›²çŠ¬ä»ªè¡¨æ¿ - å®æ—¶å›¾åƒç›‘æ§</h1>

        <div class="dashboard">
            <div class="card">
                <div class="card-title">ğŸ“¡ é›·è¾¾å›¾åƒ</div>
                <div class="image-container" id="radarContainer">
                    <div class="image-placeholder">
                        <div class="loading-spinner" style="margin: 0 auto 10px;"></div>
                        <p>ç­‰å¾…é›·è¾¾å›¾åƒ...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ğŸ“· æ‘„åƒå¤´å›¾åƒ</div>
                <div class="image-container" id="cameraContainer">
                    <div class="image-placeholder">
                        <div class="loading-spinner" style="margin: 0 auto 10px;"></div>
                        <p>ç­‰å¾…æ‘„åƒå¤´å›¾åƒ...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-section">
                <div class="section-title">WebSocket è¿æ¥çŠ¶æ€</div>
                <div id="wsStatus" class="ws-status">
                    <span class="status-indicator inactive"></span>
                    <span id="wsStatusText">æœªè¿æ¥</span>
                </div>
            </div>

            <div class="control-section">
                <div class="section-title">ğŸ® æ§åˆ¶é¢æ¿</div>
                <button class="button" onclick="connectWebSocket()">è¿æ¥ WebSocket</button>
                <button class="button secondary" onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
                <button class="button" onclick="startImageStreaming()">å¯åŠ¨å›¾åƒæ¨é€</button>
                <button class="button danger" onclick="stopImageStreaming()">åœæ­¢å›¾åƒæ¨é€</button>
                <button class="button secondary" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            </div>

            <div class="control-section">
                <div class="section-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€</div>
                <div class="status-item">
                    WebSocket è¿æ¥: <span id="wsConnStatus">âŒ å·²æ–­å¼€</span>
                </div>
                <div class="status-item">
                    å›¾åƒæ¨é€: <span id="imageStreamStatus">â¸ï¸ å·²åœæ­¢</span>
                </div>
                <div class="status-item">
                    æ¥æ”¶çš„å›¾åƒå¸§: <span id="frameCount">0</span>
                </div>
            </div>

            <div class="control-section">
                <div class="section-title">ğŸ“ ç³»ç»Ÿæ—¥å¿—</div>
                <div class="log-box" id="logBox">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…è¿æ¥...\n</div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let imageStreamingActive = false;
        let frameCount = 0;
        const logBox = document.getElementById('logBox');
        const wsStatusElement = document.getElementById('wsStatus');
        const wsStatusText = document.getElementById('wsStatusText');
        const wsConnStatus = document.getElementById('wsConnStatus');
        const imageStreamStatus = document.getElementById('imageStreamStatus');
        const frameCountElement = document.getElementById('frameCount');
        const radarContainer = document.getElementById('radarContainer');
        const cameraContainer = document.getElementById('cameraContainer');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = `[${timestamp}] ${message}\n`;
            logBox.textContent += logEntry;
            logBox.scrollTop = logBox.scrollHeight;
        }

        function clearLogs() {
            logBox.textContent = 'æ—¥å¿—å·²æ¸…ç©º\n';
        }

        function updateStatus() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                wsStatusElement.className = 'ws-status connected';
                wsStatusText.textContent = 'âœ… å·²è¿æ¥';
                wsConnStatus.textContent = 'âœ… å·²è¿æ¥';
            } else {
                wsStatusElement.className = 'ws-status';
                wsStatusText.textContent = 'âŒ æœªè¿æ¥';
                wsConnStatus.textContent = 'âŒ å·²æ–­å¼€';
            }
        }

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('âš ï¸ WebSocket å·²ç»è¿æ¥');
                return;
            }

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
                const wsUrl = `${protocol}://${window.location.host}/ws/image`;
                log(`ğŸ”— æ­£åœ¨è¿æ¥åˆ°: ${wsUrl}`);

                ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    log('âœ… WebSocket è¿æ¥æˆåŠŸ');
                    updateStatus();
                };

                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'radar') {
                            radarContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.data}" alt="Radar Image">`;
                            frameCount++;
                        } else if (data.type === 'camera') {
                            cameraContainer.innerHTML = `<img src="data:image/jpeg;base64,${data.data}" alt="Camera Image">`;
                            frameCount++;
                        }
                        frameCountElement.textContent = frameCount;
                    } catch (error) {
                        console.error('Error parsing image data:', error);
                    }
                };

                ws.onerror = function(error) {
                    log(`âŒ WebSocket é”™è¯¯: ${error}`);
                    updateStatus();
                };

                ws.onclose = function() {
                    log('âš ï¸ WebSocket å·²æ–­å¼€è¿æ¥');
                    updateStatus();
                };
            } catch (error) {
                log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
            }
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                log('âœ… WebSocket å·²æ–­å¼€');
                updateStatus();
            } else {
                log('âš ï¸ WebSocket æœªè¿æ¥');
            }
        }

        function startImageStreaming() {
            fetch('/api/image/start', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        log('âœ… å›¾åƒæ¨é€å·²å¯åŠ¨');
                        imageStreamingActive = true;
                        imageStreamStatus.textContent = 'â–¶ï¸ æ¨é€ä¸­';
                    } else {
                        log(`âŒ å¯åŠ¨å¤±è´¥: ${data.message}`);
                    }
                })
                .catch(error => {
                    log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
                });
        }

        function stopImageStreaming() {
            fetch('/api/image/stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        log('âœ… å›¾åƒæ¨é€å·²åœæ­¢');
                        imageStreamingActive = false;
                        imageStreamStatus.textContent = 'â¸ï¸ å·²åœæ­¢';
                    } else {
                        log(`âŒ åœæ­¢å¤±è´¥: ${data.message}`);
                    }
                })
                .catch(error => {
                    log(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`);
                });
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°çŠ¶æ€
        window.addEventListener('load', function() {
            updateStatus();
            log('ğŸš€ ä»ªè¡¨æ¿å·²åŠ è½½ï¼Œè¯·è¿æ¥ WebSocket');
        });
    </script>
</body>
</html>

